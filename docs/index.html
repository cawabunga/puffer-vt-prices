<!DOCTYPE html>
<html>
    <head>
        <title>Puffer VT price</title>
        <style>
            body {
                font-family:system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            }
            .green {
                color: green
            }
            .red {
                color: red
            }
            .muted {
                color: gray
            }
        </style>
    </head>
    <body>
        <div style="display: flex; flex-direction: column; align-items: center;">
        <img src="./Horizontal@2x.png" style="max-width: 200px;" />
            <h1>Puffer VT price change</h1>
            <table style="border-spacing: 1em;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Price per 1 VT</th>
                        <th>Difference</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    <script type="module">
        let entries = await (await fetch('./events.json')).json()

        const fragment = document.createDocumentFragment()

        entries.sort((a, b) => b.timestamp - a.timestamp)

        const rtf1 = new Intl.RelativeTimeFormat(navigator.language, { style: 'short' });
        const now = Date.now()


        for (const {timestamp, event} of entries) {
            const date = new Date(timestamp * 1000)
            const relativeDate = rtf1.format(Math.ceil((date - now) / (24 * 60 * 60 * 1000)), 'days')
            const diff = event.newPrice - event.oldPrice
            const diffPercentage = (diff / event.oldPrice) * 100
            const priceInEth = formatBn(BigInt(event.newPrice), 18)

            const tr = document.createElement("tr")

            tr.innerHTML += `<td>
                ${relativeDate}
                <br />
                <small class="muted">${date.toLocaleDateString()}</small>
            </td>`
            tr.innerHTML += `<td>${priceInEth}</td>`
            tr.innerHTML += `<td class='${diff > 0 ? "red" : "green"}'>
                ${diff > 0 ? "+" : ""}${diffPercentage.toFixed(4)}%
            </td>`

            fragment.appendChild(tr)
        }

        document.querySelector('tbody').appendChild(fragment)

        function formatBn(n, decimal) {
            const exp = 10n ** BigInt(decimal);
            const sign = n < 0n ? -1n : 1n;
            n = sign * n;
            const signSymbol = 0 <= sign ? '' : '-';
            const int = n / exp;
            let fraction = String(n % exp).padStart(decimal, '0');
            // Remove trailing zeros
            fraction = fraction.replace(/0+$/, '');
            return `${signSymbol}${int}.${fraction}`;
        }

    </script>
    </body>
</html>